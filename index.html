<!DOCTYPE html>
<html>
<!--
https://github.com/vahaduo/
-->
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Run PCA analysis, project samples onto predefined space and create interactive PCA plots.">
  <title>Vahaduo: Custom PCA</title>
  <script>if(!sessionStorage.getItem("_swa3")&&document.referrer.indexOf(location.protocol+"//"+location.host)!== 0){fetch("https://counter.dev/track?"+new URLSearchParams({referrer:"https://www.custompca.com",screen:screen.width+"x"+screen.height,user:"TheCount",utcoffset:"1"}))};sessionStorage.setItem("_swa3","1");</script>
  <script src="https://www.lactame.com/lib/ml/4.0.0/ml.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    * {
      scrollbar-width: auto;
      scrollbar-color: #00000077 #1c1c1c00;
    }
    textarea {
      cursor: auto;
      scrollbar-width: auto;
    }
    *::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    textarea::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    *::-webkit-scrollbar-track {
      background: #1c1c1c00;
    }
    *::-webkit-scrollbar-thumb {
      background-color: #00000077;
    }
    *::-webkit-scrollbar-corner {
      background: #1c1c1c00;
    }
    body, html {
      height: 100%;
      margin: 0px;
      background-color: #555;
      font-size: calc(0.5vw + 12px);
      font-family: sans-serif;
      color: #dadada;
    }
    nav {
      width: 100%;
      background-color: #ccc;
      background-image: linear-gradient(#ccc, #ddd);
      padding-top: 0.4em;
      padding-left: 0.4em;
      box-sizing: border-box;
    }
    header {
      float: right;
      text-align: right;
      padding-left: 0 0.4em 0 0.4em;
      margin: 0 0.7em 0 1em;
      display: inline-block;
      color: #9d9d9d;
    }
    header div {
      text-transform: uppercase;
      font-size: 0.5em;
    }
    a {
      color: inherit;
      text-decoration: inherit;
    }
    button, label {
      outline: none;
      border: none;
      margin: 0px;
      cursor: pointer;
      color: inherit;
      font-family: inherit;
    }
    #support {
      float: right;
      text-align: initial;
      padding: 0;
      margin: -0.4em 0 0 0;
      height: 2.8em;
      width: 2.8em;
      background-color: #141518;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #FF424D;
    }
    .tablink {
      text-transform: uppercase;
      padding: 0.5em;
      font-size: 1em;
      line-height: 1.4;
      background-color: #555;
    }
    .inactive {
      background: none;
      color: #666;
    }
    .inactive:focus, .inactive:hover {
      background-color: #999;
    }
    .buttons:focus, .buttons:hover {
      background-image: linear-gradient(#444, #525252);
    }
    .buttons:active {
      color: #555;
      background-color: #999;
      background-image: none;
    }
    label {
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .buttons, .buttons:disabled {
      font-size: 0.7em;
      box-sizing: border-box;
      border: none;
      min-height: 2.5em;
      padding-left: 0.7em;
      padding-right: 0.7em;
      margin-bottom: 0.4em;
      color: inherit;
      text-transform: uppercase;
      background-color: #444;
      box-shadow: 2px 2px #333;
      line-height: 1em;
    }
    .pcaoptions {
      display: none;
    }
    .dataButtonActive {
      position: relative;
    }
    .dataButtonActive:after {
      filter: drop-shadow(0px 2px 4px #0c0d0d);
      position: absolute;
      bottom: 0px;
      left: 0px;
      width: 100%;
      height: 2px;
      background-color: #959595;
      content: '';
    }
    .tabinput {
      box-sizing: border-box;
      border: none;
      margin: 0px;
      outline: 0px;
      padding: 1em;
      height: calc(100% - 4em);
      min-height: 4em;
      width: 100%;
      overflow: auto;
      resize: none;
      color: inherit;
      font-size: 0.7em;
      white-space: pre;
      background: none;
      box-shadow: 0 3px #333;
    }
    #data {
      height: calc(100% - 3em);
    }
    #filteroutput {
      box-sizing: border-box;
      border: none;
      margin: 0px;
      outline: 0px;
      padding: 1em;
      height: calc(100% - 6em);
      min-height: 12em;
      width: 100%;
      overflow: auto;
      resize: none;
      color: inherit;
      font-size: 0.65em;
      white-space: pre;
      background: #333;
      box-shadow: 2px 2px #333;
    }
    #notification {
      font-size: 0.7em;
      box-sizing: border-box;
      margin: 0.7em;
      padding: 0.5em;
      width: calc(100% - 1.4em);
      cursor: pointer;
      display: none;
    }
    #notification::before {
      content: "Ã—";
      font-weight: bold;
      margin-right: 1em;
    }
    #graphDiv {
      min-height: calc(100vh - 5.8rem);
      box-sizing: border-box;
      margin-top: 0.4em;
    }
    .js-plotly-plot {
      box-shadow: 0 -0.2em 0.2em #666, 0 1em #181818;
      background-color: #181818;
    }
    .modebar {
      right: 1em !important;
    }
    .hovertext {
      fill-opacity: 0.9;
    }
    .buttonpca {
      min-width: 5em;
      margin: 0.72em 0 0 0.6em;
    }
    #projectsources {
      min-width: 13em;
    }
    .buttongroup, #to3d {
      display: none;
    }
    .pcleft:disabled {
      width: 5em;
      margin: 0.72em 0 0 0.6em;
    }
    .pcright {
      width: 5em;
      margin: 0.72em 0 0 0;
    }
    .plusminus {
      width: 3em;
      margin: 0.72em 0 0 0;
    }
    .flexcontainer-data > .rightpanel {
      overflow-y: auto;
    }
    .flexcontainer-data {
      height: 100%;
      display: flex;
      width: 100%;
    }
    .panel {
      flex-grow: 1;
      box-sizing: border-box;
      padding: 0.6em;
    }
    .rightpanel {
      max-width: 30em;
      flex-basis: 36%;
    }
    .leftpanel {
      flex-shrink: 0;
      flex-basis: 54%;
    }
    .button100 {
      width: 100%;
    }
    .input-data {
      text-align: center;
      background-color: #333;
      outline: 0px;
      text-transform: none;
      flex-grow: 1;
      padding: 0 0 0 3em;
    }
    .div-100 {
      flex-grow: 1;
      display: flex;
      align-items: stretch;
    }
    .input-data:focus, .input-data:hover,
    .filterReset:focus:not(:hover) {
      background-image: none;
    }
    .filterReset {
      font-weight: bold;
      color: #8d8d8d;
      width: 3em;
      background-color: #333;
      flex-grow: 0;
      flex-shrink: 0;
    }
    .filteropt {
      display: flex;
      align-items: stretch;
      gap: 0.3em;
    }
    .filteropt > button {
      flex-grow: 1;
      padding-right: 0.2em !important;
      padding-left: 0.2em !important;
      flex-basis: 8rem;
    }
    .button-data {
      text-transform: none;
    }
    ::-moz-selection {
      color: #444;
      background: #dcdcdc;
    }
    ::selection {
      color: #444;
      background: #dcdcdc;
    }
    input[type="file"] {
        display: none;
    }
    input {
      font-family: inherit;
    }
    @media only screen and (max-width: 639px) {
      .flexcontainer {
        flex-direction: column-reverse;
      }
      .flexcontainer-data {
        flex-direction: column-reverse;
      }
      .rightpanel {
        max-width: none;
      }
      .flexcontainer-data > .rightpanel {
        overflow-y: initial;
      }
      .flexcontainer-data {
        height: initial;
      }
      .flexcontainer-data {
        min-height: 100%;
      }
      #filteroutput {
        min-height: 50vh;
      }
    }
  </style>
  <script>
    const plotlyMarkers = [
      [0,6],[1,6],[2,6],[3,6],[4,6],[5,6],[6,6],[7,6],[8,6],[9,6],
      [10,6],[11,6],[12,6],[13,6],[14,6],[15,6],[16,6],[17,6],[18,6],[19,6],
      [20,6],[21,6],[22,6],[23,6],[24,6],[25,6],[26,6],[27,6],/*[28,6],*/[29,6],
      /*[30,6],*/[31,6],/*[32,6],[33,6],[34,6],[35,6],[36,6],[37,6],[38,6],[39,6],
      [40,6],[41,6],[42,6],[43,6],[44,6],*/[100,6],[101,6],[102,6],[103,6],[104,6],
      [105,6],[106,6],[107,6],[108,6],[109,6],[110,6],[111,6],[112,6],[113,6],[114,6],
      [115,6],[116,6],[117,6],[118,6],[119,6],[120,6],[121,6],[122,6],[123,6],[124,6],
      [125,6],[126,6],[127,6],[128,6],[129,6],[130,6],[131,6],[132,6],[133,6],[134,6],
      [135,6],[136,6],[137,6],[138,6],[139,6],[140,6],[141,6],[142,6],[143,6],[144,6],
      [200,6],[201,6],[202,6],[203,6],[204,6],[205,6],[206,6],[207,6],[208,6],[209,6],
      [210,6],[211,6],[212,6],[213,6],[214,6],[215,6],[216,6],[217,6],[218,6],[219,6],
      [220,6],[221,6],[222,6],[223,6],[224,6],/*[236,6],*/[300,6],[301,6],[302,6],[303,6],
      [304,6],[305,6],[306,6],[307,6],[308,6],[309,6],[310,6],[311,6],[312,6],[313,6],
      [314,6],[315,6],[316,6],[317,6],[318,6],[319,6],[320,6],[321,6],[322,6],[323,6],
      [324,6],[336,6]
    ];
    let plotlyMarkers3dGecko = [
      ["circle", 2], ["square", 2], ["diamond", 3],
      ["circle-open", 3], ["square-open", 3], ["diamond-open", 4],
      /*["cross", 4],*/ ["x", 3]
    ],
    plotlyMarkers3d = [
      ["circle", 4], ["square", 4], ["diamond", 3],
      ["circle-open", 5], ["square-open", 4], ["diamond-open", 4],
      /*["cross", 4],*/ ["x", 2]
    ];
    let projectSources = true, flipX = false, flipY = false, flipZ = false,
      dimensions = 2, dimX = 1, dimY = 2, dimZ = 2, pcaDataHasChanged = true, 
      traces = [], currentDimX = dimX, currentDimY = dimY, currentDimZ = dimZ,
      active3d = false, datarevision = 0, layout2d = {}, layout3d = {}, af = false, 
      addRep = false, dataListId = 0, dataStore = [], dataActive = -1, dataCurrent = false;
    const tabNames = {"source": "source", "projected": "projected", "pcadata": "pca data"},
      plotOptions = {
        showSendToCloud: false,
        responsive: true,
        toImageButtonOptions: {
          format: 'png',
          filename: 'Vahaduo_Custom_PCA',
          height: 1200,
          width: 1600,
          scale: 1
        },
        modeBarButtonsToAdd: [
          {
            name: 'Download plot as png (custom size)',
            icon: Plotly.Icons.camera,
            click: function(gd) {
              let scene = document.getElementById('graphDiv'), 
                saveSize = prompt("Please enter plot size in px (width x height)", Math.round(scene.clientWidth) + " x " + Math.round(scene.clientHeight));
              if (saveSize != null) {
                saveSize = saveSize.split("x");
                if (saveSize.length == 2) {
                  saveSize[0] = Number(saveSize[0].trim());
                  saveSize[1] = Number(saveSize[1].trim());
                  if (Number.isInteger(saveSize[0]) &&  saveSize[0] > 1 && Number.isInteger(saveSize[1]) &&  saveSize[1] > 1 ) {
                    Plotly.downloadImage('graphDiv',{format:'png',height:saveSize[1],width:saveSize[0],filename:'Vahaduo_Custom_PCA',scale:1});
                    return;
                  }
                }
                alert("Input not in 'width x height' format.");
              }
            }
          }
        ],
      };
    
    function showNotification (message, error = 0) {
      const notification = document.getElementById("notification");
      notification.innerHTML = message;
      notification.style.display = "block";
      if (error) {
        notification.style.backgroundColor = "red";
        notification.style.color = "white";
      } else {
        notification.style.backgroundColor = "yellow";
        notification.style.color = "#666";
      }
    }
    
    function clearNotification () {
      const elmnt = document.getElementById("notification");
      elmnt.innerHTML = "";
      elmnt.style.display = "none";
      window.dispatchEvent(new Event('resize'));
    }
    
    function updateXYPC () {
      document.getElementById("optX").firstElementChild.innerHTML = "X:&nbsp;PC" + dimX;
      document.getElementById("optY").firstElementChild.innerHTML = "Y:&nbsp;PC" + dimY;
      document.getElementById("optZ").firstElementChild.innerHTML = "Z:&nbsp;PC" + dimZ;
    }
    
    function toggleOptions (option, elmnt) {
      let msg;
      
      function toggleOption (currentValue, msg, msg2 = ["no", "yes"]) {
        if (currentValue) {
          elmnt.innerHTML = msg + msg2[0];
        } else {
          elmnt.innerHTML = msg + msg2[1];
        }
      }
      
      switch (option) {
        case "projectSources":
          toggleOption(projectSources, "project&nbsp;sources&nbsp;-&nbsp;");
          projectSources = !projectSources;
          break;
        case "flipX":
          toggleOption(flipX, "flip", ["", "&nbsp;&#10004;"]);
          flipX = !flipX;
          break;
        case "flipY":
          toggleOption(flipY, "flip", ["", "&nbsp;&#10004;"]);
          flipY = !flipY;
          break;
        case "flipZ":
          toggleOption(flipZ, "flip", ["", "&nbsp;&#10004;"]);
          flipZ = !flipZ;
          break;
        case "incDimX":
          dimX == dimensions ? dimX = 1 : dimX++;
          updateXYPC();
          break;
        case "decDimX":
          dimX == 1 ? dimX = dimensions : dimX--;
          updateXYPC();
          break;
        case "incDimY":
          dimY == dimensions ? dimY = 1 : dimY++;
          updateXYPC();
          break;
        case "decDimY":
          dimY == 1 ? dimY = dimensions : dimY--;
          updateXYPC();
          break;
        case "incDimZ":
          dimZ == dimensions ? dimZ = 1 : dimZ++;
          updateXYPC();
          break;
        case "decDimZ":
          dimZ == 1 ? dimZ = dimensions : dimZ--;
          updateXYPC();
          break;
        case "addRep":
          if (addRep) {
            elmnt.innerHTML = "Add&nbsp;to:";
          } else {
            elmnt.innerHTML = "Replace:";
          }
          addRep = !addRep;
          break;
      }
    }
    
    function textareaToArray (textareaId) {
      let i, j, m, n, text1, text2, diff12, text3, diff23, 
        text4, diff34, lines, columnNum, result = {lines: [], message: "", errors: 0};
      const textarea = document.getElementById(textareaId);
      textareaId = tabNames[textareaId].toUpperCase();
      text1 = textarea.value.trim().replace(/\r\n/g,"\n").replace(/^\/\/.*\n?/gm, '').trim().replace(/\"/g,"").replace(/\</g, "&lt;").replace(/\>/g, "&gt;");
      text2 = text1.replace(/[^\S\n]/g, "");
      diff12 = text1.length - text2.length;
      if (diff12 > 0) {
        result.message += "WARNING! Number of white-space characters removed in " + textareaId + " data: "+diff12+". ";
      }
      text3 = text2.replace(/\n+/g, "\n");
      diff23 = text2.length - text3.length;
      if (diff23 > 0) {
        result.message += "WARNING! Number of empty lines removed in " + textareaId + " data: " + diff23 + ". ";
      }
      text4 = text3.replace(/\,+/g, "\,");
      diff34 = text3.length - text4.length;
      if (diff34 > 0) {
        result.message += "ERROR! Number of missing values in " + textareaId + " data: " + diff34 + ". ";
        result.errors = 1;
        result.lines = false;
        return result;
      }
      result.lines = text4.split("\n");
      columnNum = result.lines[0].split(",").length;
      if (columnNum === 1) {
        result.message += "ERROR! Data load error in " + textareaId + ". ";
        result.errors = 1;
        result.lines = false;
        return result;
      }
      if (columnNum === 2) {
        result.message += "ERROR! Data in " + textareaId + " is one-dimensional. ";
        result.errors = 1;
        result.lines = false;
        return result;
      }
      for (i = 0, n = result.lines.length; i < n; i++) {
        result.lines[i] = result.lines[i].split(",");
        if (result.lines[i].length !== columnNum) {
          result.message += "ERROR! Variable column number in " + textareaId + " data. ";
          result.errors = 1;
          result.lines = false;
          return result;
        }
        for (j = 1, m = result.lines[i].length; j < m; j++) {
          if (isNaN(result.lines[i][j])) {
            result.message += "ERROR! Non-numerical value detected in " + textareaId + " data. ";
            result.errors = 1;
            result.lines = false;
            return result;
          }
        }
      }
      for (i = 0, n = result.lines.length; i < n; i++) {
        for (j = 1; j < columnNum; j++) {
          result.lines[i][j] = Number(result.lines[i][j]);
        }
      }
      return result;
    }

    function runPCA () {
      let errors = 0, message = "", sourceArray = false, projectedArray = false, 
        taTAsource, taTAprojected;
      const projectedLen = document.getElementById("projected").value.length;
      taTAsource = textareaToArray("source");
      sourceArray = taTAsource.lines;
      message += taTAsource.message;
      errors += taTAsource.errors;
      if (projectedLen > 0) {
        taTAprojected = textareaToArray("projected");
        projectedArray = taTAprojected.lines;
        message += taTAprojected.message;
        errors += taTAprojected.errors;
      }
      if (errors) {
        showNotification(message, 1);
        return;
      } else if (projectedArray && sourceArray[0].length !== projectedArray[0].length) {
        message += "ERROR! Column number mismatch between SOURCE and PROJECTED tabs. ";
        showNotification(message, 1);
        return;
      } else {
        if (!projectedArray && !projectSources) {
          message += "WARNING! Empty PROJECTED tab. PROJECT SOURCES switched to YES. ";
          document.getElementById("projectsources").click();
        }
        let projectedNames = [], i, n, tempLine;
          if (projectedArray) {
            for (i = 0, n = projectedArray.length; i < n; i++) {
              projectedNames.push(projectedArray[i][0]);
              projectedArray[i].shift();
            }
          } else {
            projectedArray = [];
          }
          if (projectSources) {
            for (i = 0, n = sourceArray.length; i < n; i++) {
              projectedNames.push(sourceArray[i][0]);
              sourceArray[i].shift();
              projectedArray.push(sourceArray[i]);
            }
          } else {
            for (i = 0, n = sourceArray.length; i < n; i++) {
              sourceArray[i].shift();
            }
          }
        const pca = new ML.PCA(sourceArray);
        const variance = pca.getExplainedVariance();
        let componentsNum = 1, totalVariance = 0;
        if (pca.U.columns > 1 && !isNaN(variance[0]) && variance[0] < 1) {
          for (i = 0, n = variance.length; i < n; i++) {
            totalVariance += variance[i];
            if (totalVariance < 0.98 && variance[i] > 0.01) {
              componentsNum++;
            } else {
              break;
            }
          }
          if (componentsNum > 1) {
            const projected = pca.predict(projectedArray), 
              cumulativeVariance = pca.getCumulativeVariance();
            let msg = "", j;
            for (i = 0, n = projected.rows; i < n; i++) {
              msg += projectedNames[i];
              for (j = 0; j < componentsNum; j++) {
                msg += "," + (projected.data[i][j]).toFixed(6);
              }
              msg += "\n";
            }
            msg += "//\n// PC, Explained variance, Cumulative variance\n";
            for (i = 0; i < componentsNum; i++) {
              msg += "// PC" + (i + 1) + ", " + (variance[i] * 100).toFixed(1) + "%, " + (cumulativeVariance[i] * 100).toFixed(1) + "%\n"; 
            }
            msg += "//\n";

            document.getElementById("pcadata").value = msg;
            hasPCAdataChanged(true);
            let rpcabutton = document.getElementById("runpca");
            rpcabutton.style.color = "lime";
            function restyle () {
              rpcabutton.style.transition = "all 1s"
              rpcabutton.style.color = "#dadada";
            }
            function restyle2 () {
              rpcabutton.style.transition = "inherit";
            }
            setTimeout(restyle, 200);
            setTimeout(restyle2, 1000);
          } else {
            message += "ERROR! Not enough data to perform PCA. ";
            showNotification(message, 1);
            return;
          }
        } else {
          message += "ERROR! Not enough data to perform PCA. ";
          showNotification(message, 1);
          return;
        }
        clearNotification();
        if (message.length > 0) {
          showNotification(message);
        }
      }
    }
    
    function setOptDisp (display) {
      document.getElementById("optX").style.display = display;
      document.getElementById("optY").style.display = display;
      if (display == "none") {
        document.getElementById("to3d").style.display = display;
        to3d(true);  
      }
      if (display == "inline-block" && dimensions > 2) {
        document.getElementById("to3d").style.display = display;
      }
    }
    
    function to3d (reset = false) {
      if (active3d || reset) {
        active3d = false;
        document.getElementById("optZ").style.display = "none";
        document.getElementById("to3d").innerHTML = "3d";
        if (!reset) traceType("scatter");
      } else {
        active3d = true;
        document.getElementById("optZ").style.display = "inline-block";
        document.getElementById("to3d").innerHTML = "2d";
        traceType("scatter3d");
        if (dimensions > 2 && (dimZ == dimX || dimZ == dimY)) {
          for (let i = 1; i < dimensions + 1; i++) {
            if (i != dimX && i != dimY) {
              dimZ = i;
              updateXYPC();
              break;
            }
          }
        }
      }
      if (!reset) {
        plotPCA(true);
      }
    }

    function traceType (type) {
      for (let i = 0; i < traces.length; i++) {
        traces[i].type = type;
        if (type == "scatter" && traces[i].mode == "markers") {
          traces[i].marker = traces[i].marker2d;
        } else if (traces[i].mode == "markers") {
          traces[i].marker = traces[i].marker3d;
        }
      }
    }

    function hasPCAdataChanged(yesno) {
      pcaDataHasChanged = yesno;
      setOptDisp(yesno ? "none" : "inline-block");
    }
    
    function plotPCA (switch2d3d = false) {
      let i, j, k, l, m, n, currentName;
      
      function clearFlip () {
        if (flipX) document.getElementById("flipX").click();
        if (flipY) document.getElementById("flipY").click();
        if (flipZ) document.getElementById("flipZ").click();
      }
      
      function newLayout2d () {
        this.xaxis = { zeroline: false };
        this.yaxis = { zeroline: false };
        this.hovermode = "closest";
        this.dragmode = "pan";
        this.legend = { font: { size: 10, color: "#ddd" } };
        this.paper_bgcolor = "#181818";
        this.plot_bgcolor = "#181818";
        this.font = { size: 10, color: "#444" };
        this.margin = { l: 50, t: 20, b: 20 };
        this.datarevision = datarevision;
      }
      
      function newLayout3d () {
        this.xaxis = { zeroline: false };
        this.yaxis = { zeroline: false };
        this.zaxis = { zeroline: false };
        this.hovermode = "closest";
        this.dragmode = "turntable";
        this.legend = { font: { size: 10, color: "#ddd" }, itemsizing: "constant" };
        this.margin = { l: 10, t: 20, b: 10 };
        this.paper_bgcolor = "#181818";
        this.plot_bgcolor = "#181818";
        this.scene = {
          annotations: [],
          aspectmode: "data",
          bgcolor: "rgba(0,0,0,0)",
          xaxis: {
            color: "#444"
          },
          yaxis: {
            color: "#444"
          },
          zaxis: {
            color: "#444"
          },
          camera: { 
            projection: {
              type: "perspective"
            }
          }
        }
        this.datarevision = datarevision;
      }

      function trace (name, dimensions, marker = false, marker3d = false) {
        this.text = [];
        this.x = [];
        this.y = [];
        this.z = [];
        this.mode = "markers";
        this.type = "scatter";
        this.hoverinfo = "text";
        this.name = name;
        if (marker != false) {
          this.marker = { size: marker[1], symbol: marker[0], opacity: 0.75 };
          this.marker2d = { size: marker[1], symbol: marker[0], opacity: 0.75 };
          this.marker3d = { size: marker3d[1], symbol: marker3d[0], opacity: 0.75 };
        }
        this.storePCAdata = Array(dimensions);
        for (let i = 0; i < dimensions; i++) {
          this.storePCAdata[i] = [];
        }
      }
      
      function addToTrace (currentTrace, point) {
        let i, n;
        currentTrace.text.push(point[0]);
        for (i = 0, n = currentTrace.storePCAdata.length; i < n; i++) {
          currentTrace.storePCAdata[i].push(point[i + 1]);
        }
      }
      
      function flipIt (dim) {
        dim--;
        for (let i in traces) {
          for (let j in traces[i].storePCAdata[dim]) {
            traces[i].storePCAdata[dim][j] *= -1;
          }
        }
      }
      
      function switchIt (which, dim) {
        dim--;
        for (let i in traces) {
          traces[i][which] = traces[i].storePCAdata[dim];
        }
      }

      function getArraySum (arr) {
        function arrSum (total, num) {
          return total + num;
        }
        return arr.reduce(arrSum);
      }

      if (pcaDataHasChanged) {
        traces = [], layout2d = {}, layout3d = {};
        let taTApcadata = textareaToArray("pcadata");
        if (taTApcadata.errors > 0) {
          showNotification(taTApcadata.message, 1);
          setOptDisp("none");
          Plotly.purge("graphDiv");
          document.getElementById("graphDiv").classList.remove("js-plotly-plot");
          return;
        }
        clearFlip();
        dimX = 1;
        dimY = 2;
        dimZ = 2;
        updateXYPC();
        dimensions = taTApcadata.lines[0].length - 1;
        setOptDisp("inline-block");
        let labels = [], labelsOnly = [], labelsGroup = [];
        for (let i = taTApcadata.lines.length - 1; i > -1; i--) {
          if (taTApcadata.lines[i][0].substr(0,6) == 'label@') {
            taTApcadata.lines[i][0] = taTApcadata.lines[i][0].substr(6);
            labels.push(taTApcadata.lines[i].slice());
          }
          if (taTApcadata.lines[i][0].substr(0,10) == 'labelonly@') {
            taTApcadata.lines[i][0] = taTApcadata.lines[i][0].substr(10);
            labelsOnly.push((taTApcadata.lines.splice(i, 1))[0]);
          }
        }
        taTApcadata.lines.sort(function(a, b) {
          return a[0].localeCompare(b[0]);
        });
        for (i = 0, n = taTApcadata.lines.length, j = 0, k = 0, l = plotlyMarkers3d.length, m = plotlyMarkers.length; i < n; i++, j++, k++) {
          if (j == m) j = 0;
          if (k == l) k = 0;
          let newTrace = new trace(taTApcadata.lines[i][0].split(":")[0], dimensions, plotlyMarkers[j], plotlyMarkers3d[k]);
          addToTrace(newTrace, taTApcadata.lines[i]);
          while (i + 1 < n && newTrace.name == taTApcadata.lines[i + 1][0].split(":")[0]) {
            i++;
            addToTrace(newTrace, taTApcadata.lines[i]);
          }
          newTrace.x = newTrace.storePCAdata[0];
          newTrace.y = newTrace.storePCAdata[1];
          newTrace.z = newTrace.storePCAdata[1];
          traces.push(newTrace);
        }
        let groupTextTrace = new trace("Group Labels", dimensions);
        groupTextTrace.mode = "text";
        groupTextTrace.hoverinfo = "skip";
        groupTextTrace.textposition = "middle center";
        // groupTextTrace.textposition = [];
        groupTextTrace.textfont = {color: "#eee"};
        for (let i = traces.length - 1; i > -1; i--) {
          let newPoint = [traces[i].name];
          for (let j = 0; j < dimensions; j++) {
            newPoint.push(getArraySum(traces[i].storePCAdata[j]) / traces[i].storePCAdata[j].length);
          }
          /*if (traces[i].storePCAdata[0].length > 1) {
            groupTextTrace.textposition.push("middle center");
          } else {
            groupTextTrace.textposition.push("top center");
          }*/
          addToTrace(groupTextTrace, newPoint);
        }
        groupTextTrace.x = groupTextTrace.storePCAdata[0];
        groupTextTrace.y = groupTextTrace.storePCAdata[1];
        groupTextTrace.z = groupTextTrace.storePCAdata[1];
        traces.push(groupTextTrace);

        let sampleTextTrace = new trace("Sample Labels", dimensions);
        sampleTextTrace.visible = "legendonly";
        sampleTextTrace.mode = "text";
        sampleTextTrace.hoverinfo = "skip";
        sampleTextTrace.textposition = "middle right";
        sampleTextTrace.textfont = {color: "#eee"};
        for (let i = taTApcadata.lines.length - 1; i > -1; i--) {
          let tempLine = taTApcadata.lines[i].slice();
          tempLine[0] = "  â—‚ " + tempLine[0];
          addToTrace(sampleTextTrace, tempLine);
        }
        sampleTextTrace.x = sampleTextTrace.storePCAdata[0];
        sampleTextTrace.y = sampleTextTrace.storePCAdata[1];
        sampleTextTrace.z = sampleTextTrace.storePCAdata[1];
        traces.push(sampleTextTrace);

        if (labelsOnly.length > 0) {
          let textTrace = new trace("Custom Group Labels", dimensions);
          textTrace.mode = "text";
          textTrace.hoverinfo = "skip";
          textTrace.textposition = [];
          textTrace.textfont = {color: "#eee"};
          textTrace.textposition = "middle center";
          for (let i = labelsOnly.length - 1; i > -1; i--) {
            addToTrace(textTrace, labelsOnly[i]);
          }
          textTrace.x = textTrace.storePCAdata[0];
          textTrace.y = textTrace.storePCAdata[1];
          textTrace.z = textTrace.storePCAdata[1];
          traces.push(textTrace);
        }
        if (labels.length > 0) {
          let textTrace = new trace("Custom Sample Labels", dimensions);
          textTrace.mode = "text";
          textTrace.hoverinfo = "skip";
          textTrace.textposition = [];
          textTrace.textfont = {color: "#eee"};
          textTrace.textposition = "middle right";
          for (let i = labels.length - 1; i > -1; i--) {
            labels[i][0] = "  â—‚ " + labels[i][0];
            addToTrace(textTrace, labels[i]);
          }
          textTrace.x = textTrace.storePCAdata[0];
          textTrace.y = textTrace.storePCAdata[1];
          textTrace.z = textTrace.storePCAdata[1];
          traces.push(textTrace);
        }
        clearNotification();
        if (taTApcadata.message.length > 0) {
          showNotification(taTApcadata.message);
        }
        layout2d = new newLayout2d;
        layout3d = new newLayout3d;
        hasPCAdataChanged(false);
      }
      if (flipX) flipIt(dimX);
      if (flipY) flipIt(dimY);
      if (flipZ) flipIt(dimZ);
      if (currentDimX != dimX) {
        switchIt("x", dimX);
        currentDimX = dimX;
      }
      if (currentDimY != dimY) {
        switchIt("y", dimY);
        currentDimY = dimY;
      }
      if (currentDimZ != dimZ) {
        switchIt("z", dimZ);
        currentDimZ = dimZ;
      }
      datarevision++;
      layout2d.datarevision = datarevision;
      layout3d.datarevision = datarevision;
      if (!switch2d3d) {
        Plotly.react('graphDiv', traces , active3d ? layout3d : layout2d, plotOptions);
      } else {
        Plotly.newPlot('graphDiv', traces , active3d ? layout3d : layout2d, plotOptions);
      }
      clearFlip();
    }
    
    function openTab (tabid, button) {
      let i, n;
      const tabs = document.getElementsByClassName("tab"), 
        tablinks = document.getElementsByClassName("tablink");
      for (i = 0, n = tabs.length; i < n; i++) {
        tabs[i].style.display = "none";
      }
      for (i = 0, n = tablinks.length; i < n; i++) {
        tablinks[i].classList.add("inactive");
      }
      document.getElementById(tabid).style.display = "block";
      document.getElementById(tabid).focus();
      button.classList.remove("inactive");
        if (tabid == "data") {
          if (af == false) {
            document.body.addEventListener("keydown", autofocus);
            af = true;
          }
        } else {
          if (af == true) {
            document.body.removeEventListener("keydown", autofocus);
            af = false;
          }
        }
      }
      
      function autofocus (e) {
        let pressed = e.which || e.keyCode;
        if (pressed == 16) {document.getElementById("filter").focus();}
      }

      function processFiles (elmnt) {
        for (let file of elmnt.files){
          let reader = new FileReader(), 
            id = dataListId, name = file.name;
          dataStore.push({
            used: false,
            name: "",
            samples: [],
            data: []
          });
          dataListId++;
          reader.readAsText(file);
          reader.onload = function() {
            let text = reader.result;
            text = text.trim()
              .replace(/\r\n/g,"\n")
              .replace(/^\,(.*)\n/mg,"")
              .replace(/\"/g,"")
              .replace(/\</g, "&lt;")
              .replace(/\>/g, "&gt;")
              .replace(/[^\S\n]/g, "")
              .replace(/\n+/g, "\n");
            name = name.replace(/\_/g," ")
              .replace(/\.txt$/i,"")
              .replace(/\.csv$/i,"");
            dataStore[id].used = true;
            dataStore[id].name = name;
            dataStore[id].samples = text.split("\n");
            dataStore[id].data = text.split("\n");
            for (let index in dataStore[id].samples) {
              dataStore[id].samples[index] = "," + dataStore[id].samples[index].split(",")[0] + ",";
            }
            refreshDataList();
          };
          reader.onerror = function() {
            console.log("Error loading " + file.name + " file.");
          };
        }
      }

      function refreshDataList () {
        let html = "";
        for (let i = 0, n = dataStore.length; i < n; i++) {
          if (dataStore[i].used === true) {
            html += "<button class=\"buttons button100 button-data " + (i == dataActive ? "dataButtonActive" : "") + "\" onclick=\"getData(" + i + ", this)\">" + dataStore[i].name + "</button>";
          }
        }
        document.getElementById("datalist").innerHTML = html;
      }

      function removeClass (className, elements) {
        for (let element of elements) {
          element.classList.remove(className);
        }
      }

      function getData (id, button) {
        let dataButtons = document.querySelectorAll('#datalist button');
        removeClass("dataButtonActive", dataButtons);
        if (id == dataActive) {
          dataActive = -1;
          dataCurrent = false;
          dataFilter(true);
        } else {
          dataActive = id;
          button.classList.add("dataButtonActive");
          dataCurrent = dataStore[id];
          dataFilter(true);
        }
      }

      function dataFilter (highlight = false) {
        let output = document.getElementById("filteroutput"),
          input = document.getElementById("filter").value;
        input = input.trim()
          .replace(/\!/g," ! ")
          .replace(/[^\S\n]+/g," ")
          .replace(/\!\s/g,"!")
          .replace(/\!+/g,"!")
          .replace(/\,+/g,",")
          .replace(/\?+/g,"?")
          .replace(/[\s]*\?[\s]*/g,"?");
        input = input.split("?");
        for (let item in input) {
          input[item] = input[item].split(" ");
        }
        for (let item in input) {
          input[item] = input[item].filter(filter1);
        }
        input = input.filter(filter2);
        function filter1 (value) {
          return (value != "!" 
            && value !="" 
            && value !=","
            && value !="!,"
            && value !=",!");
        }
        function filter2 (value) {
          return (value.length > 0);
        }
        if (dataCurrent) {
          if (input.length < 1) {
            output.value = dataCurrent.data.join("\n");
          } else {
            let toOutput = "";
            for (let i = 0, n = dataCurrent.samples.length; i < n; i++) {
              for (let item of input) {
                let pass = 0;
                for (let item2 of item) {
                  if (item2.charAt(0) != "!") {
                    if (dataCurrent.samples[i].indexOf(item2) > -1) {
                      pass++;
                    } 
                  } else {
                    item2 = item2.substring(1);
                    if (dataCurrent.samples[i].indexOf(item2) < 0) {
                      pass++;
                    }
                  }
                }
                if (item.length == pass) {
                  toOutput += dataCurrent.data[i] + "\n";
                  break
                }
              }
            }
            toOutput = toOutput.trim();
            output.value = toOutput;
            if (highlight) { glow(document.getElementById("filter")) }
          }
        } else {
          output.value = "";
        }
      }

      function resetFilter () {
        document.getElementById("filter").value = "";
        dataFilter();
      }

      function glow (button) {
        button.style.color = "lime";
        function restyle () {
          button.style.transition = "all 1s"
          button.style.color = "#dadada";
        }
        function restyle2 () {
          button.style.transition = "inherit";
        }
        setTimeout(restyle, 200);
        setTimeout(restyle2, 1000);
      }

      function copyTo (where, button) {
        let elmnt = document.getElementById(where),
          val = elmnt.value.trim(),
          add = document.getElementById("filteroutput").value.trim();
        if (val != "") {val = val + "\n"}
        if (add != "") {add = add + "\n"}
        if (addRep) {val = ""}
        elmnt.value = val + add;
        glow(button);
      }
    
    function initialize () {
      if (navigator.userAgent.indexOf('Gecko') > -1 
          && navigator.userAgent.indexOf('like Gecko') < 0) {
        plotlyMarkers3d = plotlyMarkers3dGecko;
      };
      document.getElementById("defaulttab").click();
      document.getElementById("localfiles").value = "";
      document.getElementById("filteroutput").value = "";
    }
    
  </script>
</head>
<body>
  <nav>
    <a id="support" href="https://www.patreon.com/vahaduo" target="_blank" title="Check for updates and support Vahaduo on Patreon"><svg width="1.1em" height="1.1em" viewBox="0 0 96 96" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="bi bi-gear"><path fill-rule="evenodd" d="M -5.76128e-7,2.2693713 H 16.811241 V 94.070099 H -5.76128e-7 Z"></path><path fill-rule="evenodd" d="M 95.999996,36.68187 A 34.751972,34.751972 0 0 1 61.248024,71.433842 34.751972,34.751972 0 0 1 26.496052,36.68187 34.751972,34.751972 0 0 1 61.248024,1.9298973 34.751972,34.751972 0 0 1 95.999996,36.68187 Z"></path></svg></a>
    <header><a href="https://vahaduo.github.io/" target="_blank" title="Open Vahaduo App Gallery">Vahaduo<div>Custom PCA</div></a></header>
    <button class="tablink" id="defaulttab" onclick="openTab('data', this)">data</button><!--
    --><button class="tablink inactive" onclick="openTab('source', this)">source</button><!--
    --><button class="tablink inactive" onclick="openTab('projected', this)">projected</button><!--
    --><button class="tablink inactive" onclick="openTab('pcadata', this)">pca&nbsp;data</button><!--
    --><button class="tablink inactive" onclick="openTab('pcaplot', this)">pca&nbsp;plot</button>
  </nav>
  <div id="notification" onclick="clearNotification()"></div>
  <div class="tab" id="data" style="display: none;">
      <div class="flexcontainer-data">
        <div class="panel rightpanel">
          <label for="localfiles" class="buttons button100">
            Open files<input type="file" name="Open files" multiple="" id="localfiles" onchange="processFiles(this)">
          </label>
          <div id="datalist"></div>
        </div>
        <div class="panel leftpanel" id="xx">
          <div class="filteropt">
            <div class="div-100">
              <input spellcheck="false" class="buttons input-data" id="filter" value="" placeholder="Type to filter" oninput="dataFilter();">
              <button class="buttons filterReset" onclick="resetFilter()">Ã—</button>
            </div>
          </div>
          <div class="filteropt">
            <button class="buttons" onclick="toggleOptions('addRep', this)">add&nbsp;to:</button>
            <button class="buttons" onclick="copyTo('source', this)">source</button>
            <button class="buttons" onclick="copyTo('projected', this)">projected</button>
            <button class="buttons" onclick="copyTo('pcadata', this);hasPCAdataChanged(true)">pca&nbsp;data</button>
          </div>
          <textarea readonly spellcheck="false" class="" id="filteroutput" value="" placeholder="Press 'OPEN FILES' button and select one or multiple files to load CSV spreadsheets.&#10;Lines starting with a comma (headers) will be omitted.&#10;&#10;Press 'Shift' to focus the search field.&#10;Start typing to filter the list of samples.&#10;&#10;Search is case sensitive.&#10;&#10;'Space' - AND&#10;'!' - negation&#10;'?' - OR&#10;'abc def' - abc AND def&#10;'!abc' - NOT abc&#10;'abc !def' - abc AND NOT def&#10;'abc ? def' - abc OR def&#10;'abc def ? ghi' - (abc AND def) OR (ghi)&#10;'abc def ? abc ghi' - (abc AND def) OR (abc AND ghi)&#10;',abc' - starts with abc&#10;'abc,' - ends with abc&#10;'!,abc' - does NOT start with abc&#10;'!abc,' - does NOT end with abc&#10;'abc !def,' - abc AND does NOT end with def"></textarea>
        </div>
      </div>
    </div>
  <textarea class="tab tabinput" id="source" spellcheck="false" placeholder=" Paste data here. Comma-separated values, no header.&#10; Name format - Group_Label_Level_N:Group_Label_Level_2:Group_Label_Level_1:Sample_ID&#10; Prepend the sample name with label@ to add a label to the point.&#10; Prepend the sample name with labelonly@ to add a label to the plot without adding the point.&#10; Labels for top level groups are added automatically.&#10; Labels for all samples are added automatically and are placed on a hidden layer."></textarea>
  <textarea class="tab tabinput" id="projected" spellcheck="false" placeholder=" Paste data here. Comma-separated values, no header.&#10; Name format - Group_Label_Level_N:Group_Label_Level_2:Group_Label_Level_1:Sample_ID&#10; Prepend the sample name with label@ to add a label to the point.&#10; Prepend the sample name with labelonly@ to add a label to the plot without adding the point.&#10; Labels for top level groups are added automatically.&#10; Labels for all samples are added automatically and are placed on a hidden layer."></textarea>
  <textarea onchange="hasPCAdataChanged(true)" class="tab tabinput" id="pcadata" spellcheck="false" placeholder=" Paste data here. Comma-separated values, no header.&#10; Name format - Group_Label_Level_N:Group_Label_Level_2:Group_Label_Level_1:Sample_ID&#10; Prepend the sample name with label@ to add a label to the point.&#10; Prepend the sample name with labelonly@ to add a label to the plot without adding the point.&#10; Labels for top level groups are added automatically.&#10; Labels for all samples are added automatically and are placed on a hidden layer."></textarea>
  <div class="tab" id="pcaplot">
    <button id="projectsources" class="buttons buttonpca" onclick="toggleOptions('projectSources', this)">project&nbsp;sources&nbsp;-&nbsp;yes</button><!--
    --><button id="runpca" class="buttons buttonpca" onclick="runPCA()">run&nbsp;pca</button><!--
      --><div id="optX" class="buttongroup"><!--
        --><button class="buttons pcleft" onclick="" disabled="true">X:&nbsp;PC1</button><!--
        --><button id="flipX" class="buttons pcright" onclick="toggleOptions('flipX', this)">flip</button><!--
        --><button class="buttons plusminus" onclick="toggleOptions('decDimX', this)">-</button><!--
        --><button class="buttons plusminus" onclick="toggleOptions('incDimX', this)">+</button><!--
      --></div><!--
        --><div id="optY" class="buttongroup"><!--
        --><button class="buttons pcleft" onclick="" disabled="true">Y:&nbsp;PC2</button><!--
        --><button id="flipY" class="buttons pcright" onclick="toggleOptions('flipY', this)">flip</button><!--
        --><button class="buttons plusminus" onclick="toggleOptions('decDimY', this)">-</button><!--
        --><button class="buttons plusminus" onclick="toggleOptions('incDimY', this)">+</button><!--
      --></div><!--
      --><div id="optZ" class="buttongroup"><!--
        --><button class="buttons pcleft" onclick="" disabled="true">Z:&nbsp;PC2</button><!--
        --><button id="flipZ" class="buttons pcright" onclick="toggleOptions('flipZ', this)">flip</button><!--
        --><button class="buttons plusminus" onclick="toggleOptions('decDimZ', this)">-</button><!--
        --><button class="buttons plusminus" onclick="toggleOptions('incDimZ', this)">+</button><!--
      --></div><!--
    --><button id="to3d" class="buttons buttonpca" onclick="to3d()">3d</button><!--
    --><button class="buttons buttonpca" onclick="plotPCA()">plot&nbsp;pca</button>
    <div id="graphDiv"></div>
  </div>
  <script>
    initialize();
  </script>
</body>
</html>
